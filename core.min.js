let a=!1;let A=!1;let c=[];let d=[];var _='https://prodex-api.onrender.com/prodex',f=5_000,g=250,h=5_000,B=/fileName: "([^"]+)"/,j=/lineNumber: (\d+)/,K=/columnNumber: (\d+)/,P=(E='row')=>{var _B=document.createElement('div');_B.className='__prodex_flex';_B.style.flexDirection=E;return _B},q=()=>{var aC=P('column'),_C=o('Do magic!',function(){a=!a;r(new Date().toISOString(),a?'Magic started':'Magic stopped');_C.innerHTML=a?'Stop magic...':'Do magic!';_C.style.backgroundColor=a?'darkgreen':'green';!a&&(c.forEach(b=>b.remove()),c=[],d.forEach(t=>t.remove()),d=[])});aC.style.alignItems='flex-start';aC.style.position='fixed';aC.style.bottom=aC.style.left='0px';var aD=o(`Capture`,function(){A=!A;r(new Date().toISOString(),A?'Capture started':'Capture stopped');aD.innerHTML=A?`Stop capture`:`Capture`;if(A)u();else{var aE=document.getElementById('prodex_frame');aE?.remove();var aF=document.getElementById('prodex_video');aF?.remove()}});aD.id='prodex_capture_button';aD.style.backgroundColor='darkred';_C.id='prodex_element_button';_C.style.backgroundColor='green';var _d=document.createElement('div');_d.id='prodex_feedback_log';_d.style.backgroundColor='rgba(0, 0, 0, 0.8)';_d.style.color='white';_d.style.padding='10px';_d.style.border='1px solid rgba(255, 255, 255, 0.5)';_d.style.borderRadius=_d.style.marginTop='5px';_d.style.width='360px';_d.style.height='240px';_d.style.overflow='auto';aC.appendChild(_d);aC.appendChild(aD);aC.appendChild(_C);document.body.appendChild(aC);r(new Date().toISOString(),'ProdEx initialized');r(new Date().toISOString(),'Press `Meta + K` in Magic mode to send page level feedback');r(new Date().toISOString(),'Start an new composer chat (agent) with:\nStart a ProdEx session with id = "test"')},r=(aG,aH,aI)=>{var _D=document.getElementById('prodex_feedback_log'),F=document.createElement('code');if(!_D)return;var t=P('column');t.style.marginBottom='5px';t.style.borderBottom='1px solid rgba(255, 255, 255, 0.5)';t.style.paddingBottom='5px';t.style.flex='1';aI==='user'?t.style.alignItems='flex-end':t.style.alignItems='flex-start';F.innerText=aG;F.style.color='rgba(255, 255, 255, 0.6)';F.style.marginRight=F.style.fontSize='10px';var p=document.createElement('p');p.innerText=aH;p.style.fontSize='14px';t.appendChild(F);t.appendChild(p);_D.appendChild(t);_D.scrollTop=_D.scrollHeight},S=async (aJ,aK)=>{const aL=document.createElement('video');aL.style.display='none';aL.id='prodex_video';document.body.appendChild(aL);try{const aM=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:'browser'},video:!0,selfBrowserSurface:'include',monitorTypeSurfaces:'exclude'});let aN=!1;for(const aQ of aM.getVideoTracks())aQ.addEventListener('ended',()=>aN=!0);aL.srcObject=aM;await new Promise(aR=>aL.onloadedmetadata=aR);await aL.play();const aO=document.createElement('canvas'),aP=aO.getContext('2d'),G=()=>{aP.drawImage(aL,0,0,aO.width,aO.height);return aJ(aO.toDataURL(aK??'image/png'))},H=async ()=>{if(!_e){const aS=await G();if(!aS){aN=!0;return}_f=Math.min(_f*1.2,h)}else{_e=!1;_f=g}setTimeout(H,_f)},I=async ()=>{_e=!0;await G()};aO.width=aL.videoWidth;aO.height=aL.videoHeight;let _e=!1;let _f=g;for(const aT of ['mousemove','click','keydown','keypress','scroll','focus'])window.addEventListener(aT,I);await H();for(;;){if(aN)break;await new Promise(aU=>setTimeout(aU,100))}console.log('Stopping frame capture');return ()=>{console.log('Stopping frame capture, child');try{for(const aV of aL.srcObject.getTracks())aV.stop()}catch(aW){console.error('Error stopping video tracks:',aW)}aL.remove();aO.remove();for(const aX of ['mousemove','click','keydown','keypress','scroll','focus'])window.removeEventListener(aX,I)}}catch(aY){console.error(`Error capturing screen: ${aY}`)}return ()=>{console.log('Stopping frame capture, parent');aL.remove()}};var l=`
.__prodex_tooltip {
  position: absolute;
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  width: 200px;
  padding: 10px;
  border-radius: 5px;
  white-space: nowrap;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  z-index: 99001;

  input {
    color: #000;
    width: 100%;
    margin-top: 5px;
    padding: 5px;
    border: none;
    border-radius: 3px;
  }
}
.__prodex_button {
  margin: 2px;
  padding: 4px;
  font-size: 14px;
  color: #fff;
  border: 1px solid #fff;
  border-radius: 5px;
  cursor: pointer;
  z-index: 99000;
  width: 120px;
  display: block;
  align-items: center;
}
.__prodex_flex {
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99000;
}
.__prodex_box {
  position: absolute;
  border: 1px solid red;
  border-radius: 4px;
  background-color: rgba(255, 0, 0, 0);
  cursor: pointer;
  transition: background-color 0.2s, border 0.2s;

  :hover {
    background-color: rgba(255, 0, 0, 0.05);
    border: 2px solid red;
  }
}
`;function m(){var C=document.createElement('style');C.textContent=l;document.head.appendChild(C)}function n(){var _a=document.querySelector('script[name="prodex"]')?.src;if(!_a)return null;return new URL(_a).searchParams.get('k')}window.onload=()=>{var D=n();D&&(m(),q(),w(D))};var o=(_A,_b)=>{var _c=document.createElement('button');_c.className='__prodex_button';_c.innerText=_A;_c.onclick=_b;return _c};function T(aZ){S(bA=>(console.log(`Single frame captured: ${bA.length} bytes`),aZ(bA),!1),'image/jpeg').then(bB=>bB())}function u(){S(bC=>{if(!A)return!1;console.log(`New frame captured: ${bC.length} bytes`);var bD=document.getElementById('prodex_frame');if(bD){bD.src=bC;return!0}bD=document.createElement('img');bD.id='prodex_frame';bD.src=bC;bD.style.position='absolute';bD.style.top=bD.style.left='250px';bD.style.zIndex='99000';bD.style.width=Math.round(window.innerWidth*0.5)+'px';bD.style.height=Math.round(window.innerHeight*0.5)+'px';bD.style.border='1px solid black';document.body.appendChild(bD);return!0}).then(bE=>bE())}function v(bF,bG,bH,bI,_E,_F,_g){var _h=document.createElement('div');_h.className='__prodex_box';_F&&(_h.className=_F);_h.id=`__prodex_box--${new Date().getTime()}`;_h.style.width=`${bG}px`;_h.style.height=`${bH}px`;_h.style.top=`${bI}px`;_h.style.left=`${_E}px`;_h.addEventListener('click',function(bJ){for(const b of c)b.id!==_h.id&&b.remove();c=c.filter(b=>b.id===_h.id);for(const t of d)t.remove();d=d.filter(t=>t.id===_h.id);var bK=P(),bM=document.createElement('input');bK.style.position='absolute';bK.id=`__prodex_tooltip-flex--${_h.id}`;bK.style.top=bJ.pageY+'px';bK.style.left=bJ.pageX+'px';bK.style.width='320px';bK.style.display='flex';bK.style.flex='1';bK.style.flexDirection='column';var bL=document.createElement('div');bL.className='__prodex_tooltip';bL.id=`__prodex_tooltip--${_h.id}`;bL.style.width='100%';bL.innerText=`What do you want to do?`;bM.placeholder='Your input here';bM.style.width='100%';bM.addEventListener('keydown',function(e){if(e.key==='Enter'){r(new Date().toISOString(),bM.value,'user');_g(bM.value);for(const b of c)b.remove();c=[];for(const t of d)t.remove();d=[]}else e.key==='Escape'&&(e.preventDefault(),d.forEach(t=>t.remove()),d=[],bK.remove())});bL.appendChild(bM);bK.appendChild(bL);document.body.appendChild(bK);d.push(bL);d.push(bK);bM.focus()});_h.addEventListener('mouseout',function(){setTimeout(function(){_h.remove();c=c.filter(b=>b.id===_h.id)},100)});document.body.appendChild(_h);c.push(_h)}function w(k){aB(k,bN=>{console.log({message:bN});switch(bN.data?.type) {case 'screenshot':T(bO=>socket.send(JSON.stringify({type:'screenshot',data:{key:k,location:window.location,image:bO}})));break;case 'feedback':r(new Date().toISOString(),bN.data.feedback);break}},bP=>{aA(bQ=>{var bR=JSON.stringify({...bQ,key:k,location:window.location});console.log(`Sending data: ${bR}`);bP.send(bR)});x(bS=>{var bT=JSON.stringify({...bS,key:k,location:window.location});console.log(`Sending data: ${bT}`);bP.send(bT)})})}function x(bU){document.addEventListener('keydown',function(e){if(!a)return;if(e.composed&&e.key==='k'&&e.metaKey){for(const t of d)t.remove();d=[];var bV=P(),bX=document.createElement('input');bV.style.position='fixed';bV.style.top=bV.style.left='50%';bV.style.width='600px';bV.style.display='flex';bV.style.flex='1';bV.style.flexDirection='column';bV.style.transform='translate(-50%, -50%)';var bW=document.createElement('div');bW.className='__prodex_tooltip';bW.innerText=`What do you want to do?`;bW.style.width='100%';bX.placeholder='Your input here...';bX.style.width='100%';bX.addEventListener('keydown',function(e){if(e.key==='Enter'){r(new Date().toISOString(),bX.value,'user');bU({type:'user_input',data:{input:bX.value,page_location:{x:e.pageX,y:e.pageY},component:{}}});for(const t of d)t.remove();d=[];bV.remove()}else e.key==='Escape'&&(e.preventDefault(),d.forEach(t=>t.remove()),d=[],bV.remove())});bW.appendChild(bX);bV.appendChild(bW);document.body.appendChild(bV);d.push(bW);d.push(bV);bX.focus()}})}function y(bY,bZ=0){if(bZ>4)return null;if(bY?.return?.type?.name){var s=`${bY.return.type}`,cA=s.match(B),cB=s.match(j),cC=s.match(K);return{node:bY,name:bY.return.type.name,fileName:cA?cA[1]:null,lineNumber:cB?parseInt(cB[1]):null,columnNumber:cC?parseInt(cC[1]):null}}if(bY?._debugSource)return{node:bY,name:bY.type,fileName:bY._debugSource?.fileName,lineNumber:bY._debugSource?.lineNumber,columnNumber:bY._debugSource?.columnNumber};if(bY?.child)return y(bY.child,bZ+1);return null}function z(cD){for(const key in cD)if(key.startsWith('__reactFiber$'))return cD[key];return null}function aA(cE){document.onmousemove=e=>{if(!a)return;var cF=document.elementsFromPoint(e.clientX,e.clientY).filter(e=>!e.className.includes('__prodex')),cH=null;if(cF.length===0)return;var cG=null;for(var i=0;i<cF.length;i++){cH=cF[i];var cI=z(cH);if(cI){cG=y(cI,0);break}}if(!cG)return;for(const b of c)b.remove();c=[];v(cG.name,cH.offsetWidth,cH.offsetHeight,cH.offsetTop,cH.offsetLeft,void 0,function(cJ){cE({type:'user_input',data:{input:cJ,page_location:{x:e.pageX,y:e.pageY},component:{name:cG.name,fileName:cG.fileName,lineNumber:cG.lineNumber,columnNumber:cG.columnNumber}}})})}}function aB(k,cK,cL){socket=new WebSocket(_);socket.onopen=()=>{console.debug(`ProdEx WebSocket connected`);socket.send(JSON.stringify({type:'js_init',data:{key:k}}));cL(socket)};socket.onmessage=cM=>cK(JSON.parse(cM.data));socket.onerror=cN=>console.error(`ProdEx WebSocket error: ${cN.message}`);socket.onclose=cO=>{console.warn(`ProdEx WebSocket closed: ${cO.reason}. Reconnecting in ${f/1000} seconds.`);setTimeout(function(){aB(k,cK,cL)},f)}}
