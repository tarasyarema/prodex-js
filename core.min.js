let a=!1;let A=!1;let c=[];let d=[];var _=null,f='https://prodex-api.onrender.com/prodex',g=2147483640,h=5_000,B=250,j=5_000,K=/fileName: "([^"]+)"/,l=/lineNumber: (\d+)/,m=/columnNumber: (\d+)/,T=(aG='row')=>{var aH=document.createElement('div');aH.className='__prodex_flex';aH.style.flexDirection=aG;return aH},u=()=>{var aI=T('column'),aK=S('Do magic!',function(){a=!a;v(new Date().toISOString(),a?'Magic started':'Magic stopped');aK.innerHTML=a?'Stop magic...':'Do magic!';aK.style.backgroundColor=a?'darkgreen':'green';!a&&(c.forEach(b=>b.remove()),document.querySelectorAll('.__prodex_box').forEach(b=>b.remove()),c=[],d.forEach(t=>t.remove()),document.querySelectorAll('.__prodex_tooltip').forEach(t=>t.remove()),d=[])});aI.style.zIndex=`${g}`;aI.style.alignItems='flex-start';aI.style.position='fixed';aI.style.bottom=aI.style.left='0px';var aJ=S(`Capture`,function(){A=!A;v(new Date().toISOString(),A?'Capture started':'Capture stopped');aJ.innerHTML=A?`Stop capture`:`Capture`;if(A)y();else{var aL=document.getElementById('prodex_frame');aL?.remove();var aM=document.getElementById('prodex_video');aM?.remove()}});aJ.id='prodex_capture_button';aJ.style.backgroundColor='darkred';aK.id='prodex_element_button';aK.style.backgroundColor='green';var _d=document.createElement('div');_d.id='prodex_feedback_log';_d.style.backgroundColor='rgba(0, 0, 0, 0.8)';_d.style.color='white';_d.style.padding='10px';_d.style.border='1px solid rgba(255, 255, 255, 0.5)';_d.style.borderRadius=_d.style.marginTop='5px';_d.style.width='360px';_d.style.height='240px';_d.style.overflow='auto';aI.appendChild(_d);aI.appendChild(aJ);aI.appendChild(aK);document.body.appendChild(aI);v(new Date().toISOString(),'ProdEx initialized');v(new Date().toISOString(),'Press `Meta + K` in Magic mode to send page level feedback');v(new Date().toISOString(),`Start an new composer chat (agent) with:\nStart a ProdEx session with id = "${P}"`)},v=(aN,aO,aP)=>{var _D=document.getElementById('prodex_feedback_log'),F=document.createElement('code');if(!_D)return;var t=T('column');t.style.marginBottom='5px';t.style.borderBottom='1px solid rgba(255, 255, 255, 0.5)';t.style.paddingBottom='5px';t.style.flex='1';aP==='user'?t.style.alignItems='flex-end':t.style.alignItems='flex-start';F.innerText=aN;F.style.color='rgba(255, 255, 255, 0.6)';F.style.marginRight=F.style.fontSize='10px';var p=document.createElement('p');p.innerText=aO;p.style.fontSize='14px';t.appendChild(F);t.appendChild(p);_D.appendChild(t);_D.scrollTop=_D.scrollHeight},w=async (aQ,aR)=>{const aS=document.createElement('video');aS.style.display='none';aS.id='prodex_video';document.body.appendChild(aS);try{const aT=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:'browser'},video:!0,selfBrowserSurface:'include',monitorTypeSurfaces:'exclude'});let aU=!1;for(const aX of aT.getVideoTracks())aX.addEventListener('ended',()=>aU=!0);aS.srcObject=aT;await new Promise(aY=>aS.onloadedmetadata=aY);await aS.play();const aV=document.createElement('canvas'),aW=aV.getContext('2d'),G=()=>{aW.drawImage(aS,0,0,aV.width,aV.height);return aQ(aV.toDataURL(aR??'image/png'))},H=async ()=>{if(!_e){const aZ=await G();if(!aZ){aU=!0;return}_f=Math.min(_f*1.2,j)}else{_e=!1;_f=B}setTimeout(H,_f)},I=async ()=>{_e=!0;await G()};aV.width=aS.videoWidth;aV.height=aS.videoHeight;let _e=!1;let _f=B;for(const bA of ['mousemove','click','keydown','keypress','scroll','focus'])window.addEventListener(bA,I);await H();for(;;){if(aU)break;await new Promise(bB=>setTimeout(bB,100))}console.log('Stopping frame capture');return ()=>{console.log('Stopping frame capture, child');try{for(const bC of aS.srcObject.getTracks())bC.stop()}catch(bD){console.error('Error stopping video tracks:',bD)}aS.remove();aV.remove();for(const bE of ['mousemove','click','keydown','keypress','scroll','focus'])window.removeEventListener(bE,I)}}catch(bF){console.error(`Error capturing screen: ${bF}`)}return ()=>{console.log('Stopping frame capture, parent');aS.remove()}};var n=`
.__prodex_tooltip {
  position: absolute;
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  width: 200px;
  padding: 10px;
  border-radius: 5px;
  white-space: nowrap;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  z-index: ${g+1};

  input {
    color: #000;
    width: 100%;
    margin-top: 5px;
    padding: 5px;
    border: none;
    border-radius: 3px;
  }
}
.__prodex_button {
  margin: 2px;
  padding: 4px;
  font-size: 14px;
  color: #fff;
  border: 1px solid #fff;
  border-radius: 5px;
  cursor: pointer;
  z-index: ${g};
  width: 120px;
  display: block;
  align-items: center;
}
.__prodex_flex {
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: ${g};
}
.__prodex_box {
  position: absolute;
  border: 1px solid red;
  border-radius: 4px;
  background-color: rgba(255, 0, 0, 0.05);
  cursor: pointer;
  transition: background-color 0.2s, border 0.2s;
  z-index: ${g};

  :hover {
    background-color: rgba(255, 0, 0, 0.1);
    border: 2px solid red;
  }
}
`;function o(C){var _b='',_c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';for(var i=0;i<C;i++)_b+=_c.charAt(~~Math.random()*_c.length);return _b}var P=`pd_${o(8)}`;function q(){var _a=document.createElement('style');_a.textContent=n;document.head.appendChild(_a)}function r(){var D=document.querySelector('script[name="prodex"]')?.src;if(!D)return null;return new URL(D).searchParams.get('k')}window.onload=()=>{var _A=r();_A&&(console.log(`ProdEx initialized with key: ${_A}`),q(),u(),aA(_A))};var S=(E,_B)=>{var _C=document.createElement('button');_C.className='__prodex_button';_C.innerText=E;_C.onclick=_B;return _C};function x(bG){w(bH=>(console.log(`Single frame captured: ${bH.length} bytes`),bG(bH),!1),'image/jpeg').then(bI=>bI())}function y(){w(bJ=>{if(!A)return!1;console.log(`New frame captured: ${bJ.length} bytes`);var bK=document.getElementById('prodex_frame');if(bK){bK.src=bJ;return!0}bK=document.createElement('img');bK.id='prodex_frame';bK.src=bJ;bK.style.position='absolute';bK.style.top=bK.style.left='250px';bK.style.zIndex=`${g}`;bK.style.width=Math.round(window.innerWidth*0.5)+'px';bK.style.height=Math.round(window.innerHeight*0.5)+'px';bK.style.border='1px solid black';document.body.appendChild(bK);return!0}).then(bL=>bL())}function z(bM,bN,bO,bP,_E,_F,_g){var _h=document.createElement('div');_h.className='__prodex_box';_F&&(_h.className=_F);_h.id=`__prodex_box--${new Date().getTime()}`;_h.style.width=`${bN}px`;_h.style.height=`${bO}px`;_h.style.top=`${bP}px`;_h.style.left=`${_E}px`;_h.addEventListener('click',function(bQ){bQ.preventDefault();bQ.stopPropagation();for(const b of c)b.id!==_h.id&&b.remove();for(const b of document.querySelectorAll('.__prodex_box'))b.id!==_h.id&&b.remove();c=c.filter(b=>b.id===_h.id);for(const t of d)t.remove();d=d.filter(t=>t.id===_h.id);var bR=T(),bT=document.createElement('input');bR.style.position='absolute';bR.id=`__prodex_tooltip-flex--${_h.id}`;bR.style.top=bQ.pageY+'px';bR.style.left=bQ.pageX+'px';bR.style.width='320px';bR.style.display='flex';bR.style.flex='1';bR.style.flexDirection='column';var bS=document.createElement('div');bS.className='__prodex_tooltip';bS.id=`__prodex_tooltip--${_h.id}`;bS.style.width='100%';bS.innerText=`What do you want to do?`;bT.placeholder='Your input here';bT.style.width='100%';bT.addEventListener('keydown',function(e){if(e.key==='Enter'){v(new Date().toISOString(),bT.value,'user');_g(bT.value);for(const b of c)b.remove();for(const b of document.querySelectorAll('.__prodex_box'))b.remove();c=[];for(const t of d)t.remove();for(const t of document.querySelectorAll('.__prodex_tooltip'))t.remove();d=[]}else e.key==='Escape'&&(e.preventDefault(),d.forEach(t=>t.remove()),document.querySelectorAll('.__prodex_tooltip').forEach(t=>t.remove()),d=[],bR.remove())});bS.appendChild(bT);bR.appendChild(bS);document.body.appendChild(bR);d.push(bS);d.push(bR);bT.focus()});_h.addEventListener('mouseout',function(){setTimeout(function(){_h.remove();for(const b of document.querySelectorAll('.__prodex_box'))b.id!==_h.id&&b.remove();c=c.filter(b=>b.id===_h.id)},100)});document.body.appendChild(_h);c.push(_h)}function aA(k){aF(k,bU=>{switch(bU.data?.type) {case 'screenshot':x(bV=>_?.send(JSON.stringify({type:'screenshot',data:{key:k,location:window.location,image:bV}})));break;case 'feedback':v(new Date().toISOString(),bU.data.feedback);break}},s=>{aE(bW=>{s.send(JSON.stringify({...bW,key:k,location:window.location}))});aB(bX=>{s.send(JSON.stringify({...bX,key:k,location:window.location}))})})}function aB(bY){document.addEventListener('keydown',function(e){if(!a)return;if(e.composed&&e.key==='k'&&e.metaKey){for(const t of d)t.remove();for(const t of document.querySelectorAll('.__prodex_tooltip'))t.remove();d=[];var bZ=T(),cB=document.createElement('input');bZ.style.position='fixed';bZ.style.top=bZ.style.left='50%';bZ.style.width='600px';bZ.style.display='flex';bZ.style.flex='1';bZ.style.flexDirection='column';bZ.style.transform='translate(-50%, -50%)';var cA=document.createElement('div');cA.className='__prodex_tooltip';cA.innerText=`What do you want to do?`;cA.style.width='100%';cB.placeholder='Your input here...';cB.style.width='100%';cB.addEventListener('keydown',function(e){if(e.key==='Enter'){v(new Date().toISOString(),cB.value,'user');bY({type:'user_input',data:{input:cB.value,page_location:{x:e.pageX,y:e.pageY},component:{}}});for(const t of d)t.remove();d=[];bZ.remove()}else e.key==='Escape'&&(e.preventDefault(),d.forEach(t=>t.remove()),d=[],bZ.remove())});cA.appendChild(cB);bZ.appendChild(cA);document.body.appendChild(bZ);d.push(cA);d.push(bZ);cB.focus()}})}function aC(cC,cD=0){if(cD>4)return null;if(cC?.return?.type?.name){var s=`${cC.return.type}`,cE=s.match(K),cF=s.match(l),cG=s.match(m);return{node:cC,name:cC.return.type.name,fileName:cE?cE[1]:null,lineNumber:cF?parseInt(cF[1]):null,columnNumber:cG?parseInt(cG[1]):null}}if(cC?._debugSource)return{node:cC,name:cC.type,fileName:cC._debugSource?.fileName,lineNumber:cC._debugSource?.lineNumber,columnNumber:cC._debugSource?.columnNumber};if(cC?.child)return aC(cC.child,cD+1);return null}function aD(cH){for(const key in cH)if(key.startsWith('__reactFiber$'))return cH[key];return null}function aE(cI){document.onmousemove=e=>{if(!a)return;var cJ=document.elementsFromPoint(e.clientX,e.clientY).filter(e=>!e.className.includes('__prodex')),cL=null;if(cJ.length===0)return;var cK=null;for(var i=0;i<cJ.length;i++){cL=cJ[i];var cM=aD(cL);if(cM){cK=aC(cM,0);break}}if(!cK)return;for(const b of c)b.remove();for(const b of document.querySelectorAll('.__prodex_box'))b.remove();c=[];var _G=cL.getBoundingClientRect();z(cK.name,_G.width,_G.height,_G.top+window.scrollY,_G.left+window.scrollX,void 0,function(cN){cI({type:'user_input',data:{input:cN,page_location:{x:e.pageX,y:e.pageY},component:{name:cK.name,fileName:cK.fileName,lineNumber:cK.lineNumber,columnNumber:cK.columnNumber}}})})}}function aF(k,cO,cP){_=new WebSocket(f);_.onopen=()=>{console.debug(`ProdEx WebSocket connected`);_.send(JSON.stringify({type:'js_init',data:{key:k,id:P}}));cP(_)};_.onmessage=cQ=>cO(JSON.parse(cQ.data));_.onerror=cR=>console.error(`ProdEx WebSocket error: ${cR.message}`);_.onclose=cS=>{console.warn(`ProdEx WebSocket closed: ${cS.reason}. Reconnecting in ${h/1000} seconds.`);setTimeout(function(){aF(k,cO,cP)},h)}}
