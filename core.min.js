let a=!1;let A=!1;let c=[];let d=[];var _=null,f='https://prodex-api.onrender.com/prodex',g=5_000,h=250,B=5_000,j=/fileName: "([^"]+)"/,K=/lineNumber: (\d+)/,l=/columnNumber: (\d+)/,q=(E='row')=>{var _B=document.createElement('div');_B.className='__prodex_flex';_B.style.flexDirection=E;return _B},r=()=>{var aD=q('column'),_C=P('Do magic!',function(){a=!a;S(new Date().toISOString(),a?'Magic started':'Magic stopped');_C.innerHTML=a?'Stop magic...':'Do magic!';_C.style.backgroundColor=a?'darkgreen':'green';!a&&(c.forEach(b=>b.remove()),document.querySelectorAll('.__prodex_box').forEach(b=>b.remove()),c=[],d.forEach(t=>t.remove()),document.querySelectorAll('.__prodex_tooltip').forEach(t=>t.remove()),d=[])});aD.style.alignItems='flex-start';aD.style.position='fixed';aD.style.bottom=aD.style.left='0px';var aE=P(`Capture`,function(){A=!A;S(new Date().toISOString(),A?'Capture started':'Capture stopped');aE.innerHTML=A?`Stop capture`:`Capture`;if(A)v();else{var aF=document.getElementById('prodex_frame');aF?.remove();var aG=document.getElementById('prodex_video');aG?.remove()}});aE.id='prodex_capture_button';aE.style.backgroundColor='darkred';_C.id='prodex_element_button';_C.style.backgroundColor='green';var _d=document.createElement('div');_d.id='prodex_feedback_log';_d.style.backgroundColor='rgba(0, 0, 0, 0.8)';_d.style.color='white';_d.style.padding='10px';_d.style.border='1px solid rgba(255, 255, 255, 0.5)';_d.style.borderRadius=_d.style.marginTop='5px';_d.style.width='360px';_d.style.height='240px';_d.style.overflow='auto';aD.appendChild(_d);aD.appendChild(aE);aD.appendChild(_C);document.body.appendChild(aD);S(new Date().toISOString(),'ProdEx initialized');S(new Date().toISOString(),'Press `Meta + K` in Magic mode to send page level feedback');S(new Date().toISOString(),'Start an new composer chat (agent) with:\nStart a ProdEx session with id = "test"')},S=(aH,aI,aJ)=>{var _D=document.getElementById('prodex_feedback_log'),F=document.createElement('code');if(!_D)return;var t=q('column');t.style.marginBottom='5px';t.style.borderBottom='1px solid rgba(255, 255, 255, 0.5)';t.style.paddingBottom='5px';t.style.flex='1';aJ==='user'?t.style.alignItems='flex-end':t.style.alignItems='flex-start';F.innerText=aH;F.style.color='rgba(255, 255, 255, 0.6)';F.style.marginRight=F.style.fontSize='10px';var p=document.createElement('p');p.innerText=aI;p.style.fontSize='14px';t.appendChild(F);t.appendChild(p);_D.appendChild(t);_D.scrollTop=_D.scrollHeight},T=async (aK,aL)=>{const aM=document.createElement('video');aM.style.display='none';aM.id='prodex_video';document.body.appendChild(aM);try{const aN=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:'browser'},video:!0,selfBrowserSurface:'include',monitorTypeSurfaces:'exclude'});let aO=!1;for(const aR of aN.getVideoTracks())aR.addEventListener('ended',()=>aO=!0);aM.srcObject=aN;await new Promise(aS=>aM.onloadedmetadata=aS);await aM.play();const aP=document.createElement('canvas'),aQ=aP.getContext('2d'),G=()=>{aQ.drawImage(aM,0,0,aP.width,aP.height);return aK(aP.toDataURL(aL??'image/png'))},H=async ()=>{if(!_e){const aT=await G();if(!aT){aO=!0;return}_f=Math.min(_f*1.2,B)}else{_e=!1;_f=h}setTimeout(H,_f)},I=async ()=>{_e=!0;await G()};aP.width=aM.videoWidth;aP.height=aM.videoHeight;let _e=!1;let _f=h;for(const aU of ['mousemove','click','keydown','keypress','scroll','focus'])window.addEventListener(aU,I);await H();for(;;){if(aO)break;await new Promise(aV=>setTimeout(aV,100))}console.log('Stopping frame capture');return ()=>{console.log('Stopping frame capture, child');try{for(const aW of aM.srcObject.getTracks())aW.stop()}catch(aX){console.error('Error stopping video tracks:',aX)}aM.remove();aP.remove();for(const aY of ['mousemove','click','keydown','keypress','scroll','focus'])window.removeEventListener(aY,I)}}catch(aZ){console.error(`Error capturing screen: ${aZ}`)}return ()=>{console.log('Stopping frame capture, parent');aM.remove()}};var m=`
.__prodex_tooltip {
  position: absolute;
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  width: 200px;
  padding: 10px;
  border-radius: 5px;
  white-space: nowrap;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  z-index: 99001;

  input {
    color: #000;
    width: 100%;
    margin-top: 5px;
    padding: 5px;
    border: none;
    border-radius: 3px;
  }
}
.__prodex_button {
  margin: 2px;
  padding: 4px;
  font-size: 14px;
  color: #fff;
  border: 1px solid #fff;
  border-radius: 5px;
  cursor: pointer;
  z-index: 99000;
  width: 120px;
  display: block;
  align-items: center;
}
.__prodex_flex {
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99000;
}
.__prodex_box {
  position: absolute;
  border: 1px solid red;
  border-radius: 4px;
  background-color: rgba(255, 0, 0, 0.05);
  cursor: pointer;
  transition: background-color 0.2s, border 0.2s;
  z-index: 99000;

  :hover {
    background-color: rgba(255, 0, 0, 0.1);
    border: 2px solid red;
  }
}
`;function n(){var C=document.createElement('style');C.textContent=m;document.head.appendChild(C)}function o(){var _a=document.querySelector('script[name="prodex"]')?.src;if(!_a)return null;return new URL(_a).searchParams.get('k')}window.onload=()=>{var D=o();D&&(n(),r(),x(D))};var P=(_A,_b)=>{var _c=document.createElement('button');_c.className='__prodex_button';_c.innerText=_A;_c.onclick=_b;return _c};function u(bA){T(bB=>(console.log(`Single frame captured: ${bB.length} bytes`),bA(bB),!1),'image/jpeg').then(bC=>bC())}function v(){T(bD=>{if(!A)return!1;console.log(`New frame captured: ${bD.length} bytes`);var bE=document.getElementById('prodex_frame');if(bE){bE.src=bD;return!0}bE=document.createElement('img');bE.id='prodex_frame';bE.src=bD;bE.style.position='absolute';bE.style.top=bE.style.left='250px';bE.style.zIndex='99000';bE.style.width=Math.round(window.innerWidth*0.5)+'px';bE.style.height=Math.round(window.innerHeight*0.5)+'px';bE.style.border='1px solid black';document.body.appendChild(bE);return!0}).then(bF=>bF())}function w(bG,bH,bI,bJ,_E,_F,_g){var _h=document.createElement('div');_h.className='__prodex_box';_F&&(_h.className=_F);_h.id=`__prodex_box--${new Date().getTime()}`;_h.style.width=`${bH}px`;_h.style.height=`${bI}px`;_h.style.top=`${bJ}px`;_h.style.left=`${_E}px`;_h.addEventListener('click',function(bK){bK.preventDefault();bK.stopPropagation();for(const b of c)b.id!==_h.id&&b.remove();for(const b of document.querySelectorAll('.__prodex_box'))b.id!==_h.id&&b.remove();c=c.filter(b=>b.id===_h.id);for(const t of d)t.remove();d=d.filter(t=>t.id===_h.id);var bL=q(),bN=document.createElement('input');bL.style.position='absolute';bL.id=`__prodex_tooltip-flex--${_h.id}`;bL.style.top=bK.pageY+'px';bL.style.left=bK.pageX+'px';bL.style.width='320px';bL.style.display='flex';bL.style.flex='1';bL.style.flexDirection='column';var bM=document.createElement('div');bM.className='__prodex_tooltip';bM.id=`__prodex_tooltip--${_h.id}`;bM.style.width='100%';bM.innerText=`What do you want to do?`;bN.placeholder='Your input here';bN.style.width='100%';bN.addEventListener('keydown',function(e){if(e.key==='Enter'){S(new Date().toISOString(),bN.value,'user');_g(bN.value);for(const b of c)b.remove();for(const b of document.querySelectorAll('.__prodex_box'))b.remove();c=[];for(const t of d)t.remove();for(const t of document.querySelectorAll('.__prodex_tooltip'))t.remove();d=[]}else e.key==='Escape'&&(e.preventDefault(),d.forEach(t=>t.remove()),document.querySelectorAll('.__prodex_tooltip').forEach(t=>t.remove()),d=[],bL.remove())});bM.appendChild(bN);bL.appendChild(bM);document.body.appendChild(bL);d.push(bM);d.push(bL);bN.focus()});_h.addEventListener('mouseout',function(){setTimeout(function(){_h.remove();for(const b of document.querySelectorAll('.__prodex_box'))b.id!==_h.id&&b.remove();c=c.filter(b=>b.id===_h.id)},100)});document.body.appendChild(_h);c.push(_h)}function x(k){aC(k,bO=>{switch(bO.data?.type) {case 'screenshot':u(bP=>_?.send(JSON.stringify({type:'screenshot',data:{key:k,location:window.location,image:bP}})));break;case 'feedback':S(new Date().toISOString(),bO.data.feedback);break}},s=>{aB(bQ=>{s.send(JSON.stringify({...bQ,key:k,location:window.location}))});y(bR=>{s.send(JSON.stringify({...bR,key:k,location:window.location}))})})}function y(bS){document.addEventListener('keydown',function(e){if(!a)return;if(e.composed&&e.key==='k'&&e.metaKey){for(const t of d)t.remove();for(const t of document.querySelectorAll('.__prodex_tooltip'))t.remove();d=[];var bT=q(),bV=document.createElement('input');bT.style.position='fixed';bT.style.top=bT.style.left='50%';bT.style.width='600px';bT.style.display='flex';bT.style.flex='1';bT.style.flexDirection='column';bT.style.transform='translate(-50%, -50%)';var bU=document.createElement('div');bU.className='__prodex_tooltip';bU.innerText=`What do you want to do?`;bU.style.width='100%';bV.placeholder='Your input here...';bV.style.width='100%';bV.addEventListener('keydown',function(e){if(e.key==='Enter'){S(new Date().toISOString(),bV.value,'user');bS({type:'user_input',data:{input:bV.value,page_location:{x:e.pageX,y:e.pageY},component:{}}});for(const t of d)t.remove();d=[];bT.remove()}else e.key==='Escape'&&(e.preventDefault(),d.forEach(t=>t.remove()),d=[],bT.remove())});bU.appendChild(bV);bT.appendChild(bU);document.body.appendChild(bT);d.push(bU);d.push(bT);bV.focus()}})}function z(bW,bX=0){if(bX>4)return null;if(bW?.return?.type?.name){var s=`${bW.return.type}`,bY=s.match(j),bZ=s.match(K),cA=s.match(l);return{node:bW,name:bW.return.type.name,fileName:bY?bY[1]:null,lineNumber:bZ?parseInt(bZ[1]):null,columnNumber:cA?parseInt(cA[1]):null}}if(bW?._debugSource)return{node:bW,name:bW.type,fileName:bW._debugSource?.fileName,lineNumber:bW._debugSource?.lineNumber,columnNumber:bW._debugSource?.columnNumber};if(bW?.child)return z(bW.child,bX+1);return null}function aA(cB){for(const key in cB)if(key.startsWith('__reactFiber$'))return cB[key];return null}function aB(cC){document.onmousemove=e=>{if(!a)return;var cD=document.elementsFromPoint(e.clientX,e.clientY).filter(e=>!e.className.includes('__prodex')),cF=null;if(cD.length===0)return;var cE=null;for(var i=0;i<cD.length;i++){cF=cD[i];var cG=aA(cF);if(cG){cE=z(cG,0);break}}if(!cE)return;for(const b of c)b.remove();for(const b of document.querySelectorAll('.__prodex_box'))b.remove();c=[];var _G=cF.getBoundingClientRect();w(cE.name,_G.width,_G.height,_G.top+window.scrollY,_G.left+window.scrollX,void 0,function(cH){cC({type:'user_input',data:{input:cH,page_location:{x:e.pageX,y:e.pageY},component:{name:cE.name,fileName:cE.fileName,lineNumber:cE.lineNumber,columnNumber:cE.columnNumber}}})})}}function aC(k,cI,cJ){_=new WebSocket(f);_.onopen=()=>{console.debug(`ProdEx WebSocket connected`);_.send(JSON.stringify({type:'js_init',data:{key:k}}));cJ(_)};_.onmessage=cK=>cI(JSON.parse(cK.data));_.onerror=cL=>console.error(`ProdEx WebSocket error: ${cL.message}`);_.onclose=cM=>{console.warn(`ProdEx WebSocket closed: ${cM.reason}. Reconnecting in ${g/1000} seconds.`);setTimeout(function(){aC(k,cI,cJ)},g)}}
